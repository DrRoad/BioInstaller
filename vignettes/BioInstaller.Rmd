---
title: "Introduction to BioInstaller"
author: "Jianfeng Li"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    toc: true
    theme: cayman
    highlight: github
  pdf_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Introduction to BioInstaller}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
```

## Introduction

BioInstaller is a downloader and installer of bio-software and bio-database. The inspiration for this project comes from various types convenient package manager, such as [pip](https://pypi.python.org/pypi/pip) for Python package, `install.packages` for R package, biocLite for [Bioconductor](http://www.bioconductor.org) R package, etc.

**Why we do not have an integrated bioinformatics database and software package manager?**

In fact, there are already some tools can complete part of the work:

[Conda](https://conda.io/docs/intro.html) and [BioConda](http://bioconda.github.io) have done a lot of work and we can use them to conveniently install some bioinformatics software. But there are still many problems with these package managers, such as version updating not timely, incompatible to some precompiled programs, little support for the database and other non-software files.

[docker](https://www.docker.com/) is another kind very promising tool to complete the migration of the analytical environment. But the root authority is required that it's difficult for you to always get root privileges.

Furthermore, learning how to install and compile bioinformatics software is still necessary, because these 'unpleasant' experience will help you to improve the ability to debug and modify programs.

As for me, when starting some NGS analysis work in a new computer or operating system, I have to spend much time and energy to
establish a complete set of software and dependent files with the corresponding configuration file.

BioInstaller can help us to download, install and manage a variety of bioinformatics tools and databases.

What's more, BioInstaller provides a different way to download and install your files, softwares, and databases. More detail can be found in another vignette [Examples of Templet Configuration File](https://CRAN.R-project.org/package=BioInstaller/vignettes/write_configuration_file.html).

**Feature**:

- Extendible
- Craw the source code and version information from the original site
- One step installation or download softwares and databases (Partial dependence supported)

## Core Functions

Function `set.biosoftwares.db()` can be used to set a database file saving the information of installed software and database.

Next, you can use the function `install.bioinfo(show.all.names = TRUE)` get all soteware and database supported by BioInstaller.

```{r}
library(BioInstaller)
set.biosoftwares.db(tempfile())
# Show all avaliable softwares/dependece in default inst/extdata/config/github/github.toml 
# and inst/extdata/config/nongithub/nongithub.toml
x <- install.bioinfo(show.all.names = TRUE)

suppressWarnings(
  knitr::kable(col.names = c("", "", ""), matrix(x, ncol=3), caption = sprintf("Softwares and databases supported by BioInstaller (n=%s)", length(x)))
)
```

If you known the `name` of software/database, the followed command can to get its available versions.

```{r}
# Fetching versions of softwares
install.bioinfo(name = 'samtools', show.all.versions = TRUE)
```

Parameter `verbose` in `install.bioinfo` can be used to show the extra debug information. 

Besdes, if you only want to download the source code or raw database files to a specific directory, the parameter `download.dir` and `download.only`are required. 

```{r}
# Install 'demo' with debug infomation
download.dir <- sprintf('%s/demo_2', tempdir())
install.bioinfo('demo', download.dir = download.dir, verbose = TRUE)

# Download demo source code
download.dir <- sprintf('%s/demo_3', tempdir())
install.bioinfo('demo', download.dir = download.dir,
  download.only = TRUE, verbose = TRUE)
```

After the download step finished, commonly you need to install the softwares by several commands or a script. BioInstaller provides `destdir` to simulate `./configure --prefix={{destdir}}; make; make install` for compiling C program. It will create `bin` directory in the `destdir`, and copy the executable files. If you want to download in `A` and install to `B`, it is required to simultaneously set the parameters `destdir` and `download.dir`.

```{r}
# Set download.dir and destdir (destdir like /usr/local 
# including bin, lib, include and others), 
# destdir will work if install step {{destdir}} be used
download.dir <- sprintf('%s/demo_source', tempdir())
destdir <- sprintf('%s/demo', tempdir())
install.bioinfo('demo', download.dir = download.dir, destdir = destdir)
```

## Saved informations after installation

It is important to save related inforamtion of instaltion, and can help you to use the softwares or database in the other pipeline. So, after installed the softwares and database, BioInstaller will save the informations, such as softwares name, version, path, update time, in the database file setted by function `set.biosoftwares.db()`, which also defeind by environment variable `BIO_SOFWARES_DB_ACTIVE`. 

```{r}
temp.db <- tempfile()
set.biosoftwares.db(temp.db)
is.biosoftwares.db.active(temp.db)

# Install 'demo' quite
download.dir <- sprintf('%s/demo_1', tempdir())
install.bioinfo('demo', download.dir = download.dir, verbose = FALSE)
```

Function `get.info()` can be used to get the saved informations of installed softwares and databases. 

When you want to delete the saved inforamtion, you can use function `del.info`.

```{r}
config <- get.info('demo')
config

config <- configr::read.config(temp.db)
config$demo$comments <- 'This is a demo.'
params <- list(config.dat = config, file.path = temp.db)
do.call(configr::write.config, params)
get.info('demo')
del.info('demo')
```

## Local mode

Local mode of BioInstaller was userful when you have download the source code or database file, and have not run the install steps. softwawre. 

Tips about local mode:

- Github software/database: a cloned directory were required 
- Non-github software/database: a decompressed directory or a compressed archive.

```{r}
download.dir <- sprintf('%s/github_demo_local', tempdir())
install.bioinfo('github_demo', download.dir = download.dir, download.only = TRUE, verbose = FALSE)
install.bioinfo('github_demo', local.source = download.dir)

download.dir <- sprintf('%s/demo_local', tempdir())
install.bioinfo('demo_2', download.dir = download.dir, download.only = TRUE, verbose = FALSE)
install.bioinfo('demo_2', download.dir = download.dir, local.source = sprintf('%s/GRCh37_MT_ensGene.txt.gz', download.dir), decompress = TRUE)
```

## Download all versions

Function `craw.all.version` is the simplest method to download all avaliable URL files in nongithub or datatabase files.

```{r}
download.dir <- sprintf('%s/craw_all_versions', tempdir())
craw.all.versions('demo', download.dir = download.dir)
```

## Meta information of software and database

Function `get.meta` can be used to get all softwares and databases meta inforamtion, such as description and publication, supported by BioInstaller. 

```{r}
# Get all meta source files
meta_files <- get.meta.files()
meta_files

# Get all of meta informaton in BioInstaller
meta <- get.meta()
names(meta)
meta[1:4]
meta$db$cfg_meta
meta$db$item$atcircdb

# Examples of get.meta
db_cfg_meta <- get.meta(value = "cfg_meta", config = 'db')
db_cfg_meta

db_cfg_meta_parsed <- get.meta(value = 'cfg_meta', config = 'db', read.config.params = list(rcmd.parse = TRUE))
db_cfg_meta_parsed

db_cfg_meta <- get.meta(config = 'github', value = 'item')
db_cfg_meta$bwa

# Get databases meta file
db_meta_file <- get.meta(config = 'db_meta_file')
db_meta_file
db_meta_file <- meta_files[["db_meta_file"]]
db_meta_file
```

## Download database

Database files are required for almost all bioinformatics data analysis pipeline, especialy for sequnce mapping and annotation steps. We hope BioInstaller can help you to access these resources easily in R, and you can use function `install.bioinfo` directly download the supported databases.

```{r}
# get all database name
library(stringr)
x <- install.bioinfo(show.all.names = T)
x <- x[str_detect(x, "^db_|reffa")]
suppressWarnings(
  knitr::kable(col.names = c("", "", ""), matrix(x, ncol=3), caption = sprintf("Softwares and databases supported by BioInstaller (n=%s)", length(x)))
)

# all databases config 
db_cfg_meta <- get.meta(config = 'db', value = 'cfg_meta', 
                        read.config.params=list(rcmd.parse = TRUE))
cfg_dir <- db_cfg_meta$cfg_dir
cfg_dir
avaliable_cfg <- db_cfg_meta$avaliable_cfg
avaliable_cfg
sprintf("%s/%s", cfg_dir, avaliable_cfg)
```

Just like [ANNOVAR](http://annovar.openbioinformatics.org/en/latest/) and [Bioconductor](http://www.bioconductor.org/) have done, we hope to establish a integrated and shared database pool in this tool. 

```{r}
# ANNOVAR
download.dir <- sprintf('%s/db_annovar', tempdir())
config.toml <- system.file("extdata", "config/db/db_annovar.toml", 
  package = "BioInstaller")
#install.bioinfo('db_ucsc_refgene', download.dir = download.dir, 
#  nongithub.cfg = config.toml, extra.list = list(buildver = "hg19"))

# db_main
download.dir <- sprintf('%s/db_main', tempdir())
config.toml <- system.file("extdata", "config/db/db_main.toml", 
  package = "BioInstaller")
install.bioinfo('db_diseaseenhancer', download.dir = download.dir, 
  nongithub.cfg = config.toml)
```

## Write you own configuration file

If the software and database have not been supported by BioInstaller, you can write your own `YAML` or `TOML` format configuration file. A related [vignette](https://life2cloud.com/tools/bioinstaller/articles/write_configuration_file.html) can help you to do this.

## Session info

Here is the output of `sessionInfo()` on the system on which this document was compiled:

```{r echo=FALSE}
sessionInfo()
```
